// File: backend/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

// ============================================
// 1. USERS TABLE
// ============================================
model users {
  id                      String   @id @default(uuid())
  name                    String
  email                   String   @unique
  password                String
  user_role               String   @default("student")
  image_path              String?
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt

  // Legacy JSON fields
  ai_persona              Json?
  pomodoro_config         Json?
  learning_categories     Json?
  refresh_token           String?

  // ðŸ”¹ ML Prediction Results
  ml_predicted_persona    String? @db.Text
  ml_confidence           Float?
  ml_last_prediction_at   DateTime? @db.Timestamptz(6)

  // ðŸ”¹ ML-Generated Insights
  personalized_insight    String? @db.Text
  learning_recommendation String? @db.Text

  // Relations
  journeys_as_instructor developer_journeys[]            @relation("instructor")
  journeys_as_reviewer   developer_journeys[]            @relation("reviewer")
  trackings              developer_journey_trackings[]
  submissions            developer_journey_submissions[]
  completions            developer_journey_completions[]
  exam_registrations     exam_registrations[]
  weekly_reports         weekly_reports[]
  notifications          notifications[]
  
  // ðŸ”¥ NEW RELATION: Pomodoro Sessions
  pomodoro_sessions      pomodoro_sessions[]

  @@map("users")
}

// ============================================
// 2. WEEKLY REPORTS
// ============================================
model weekly_reports {
  id                      Int      @id @default(autoincrement())
  user_id                 String
  week_number             Int
  week_start_date         DateTime @db.Date
  week_end_date           DateTime @db.Date

  // Study Metrics
  total_study_time_hours Float?   @default(0) 
  total_pomodoro_sessions Int?     @default(0) 
  avg_session_duration    Float?   @default(0) 
  total_activities        Int?     @default(0) 

  // Engagement Metrics
  engagement_score        Float?   @default(0) 
   
  created_at              DateTime? @default(now()) @db.Timestamptz(6)
  updated_at              DateTime? @default(now()) @db.Timestamptz(6)

  user                    users     @relation(fields: [user_id], references: [id])

  @@map("weekly_reports")
}

// ============================================
// 3. NOTIFICATIONS
// ============================================
model notifications {
  id             String   @id @default(uuid())
  user_id        String
  title          String
  message        String   @db.Text
  priority       String   @default("normal") 
  is_read        Boolean  @default(false)
  created_at     DateTime @default(now()) @db.Timestamptz(6)

  user           users @relation(fields: [user_id], references: [id])

  @@map("notifications")
}

// ============================================
// 4. DEVELOPER JOURNEYS
// ============================================
model developer_journeys {
  id             String    @id @default(uuid())
  name           String
  summary        String?   @db.Text
  difficulty     String
  description    String?   @db.Text
  status         String    @default("draft")
  listed         Boolean   @default(true)
  instructor_id  String
  reviewer_id    String?
  deadline       DateTime?
  hours_to_study Int?
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  // Relations
  instructor     users                              @relation("instructor", fields: [instructor_id], references: [id])
  reviewer       users?                             @relation("reviewer", fields: [reviewer_id], references: [id])
  tutorials      developer_journey_tutorials[]
  trackings      developer_journey_trackings[]
  submissions    developer_journey_submissions[]
  completions    developer_journey_completions[]
  
  // ðŸ”¥ NEW RELATION: Pomodoro Sessions (Optional link to journey)
  pomodoro_sessions pomodoro_sessions[]

  @@map("developer_journeys")
}

// ============================================
// 5. DEVELOPER JOURNEY TUTORIALS
// ============================================
model developer_journey_tutorials {
  id                   String    @id @default(uuid())
  developer_journey_id String
  title                String
  type                 String    @default("article")
  content              String?   @db.Text
  position             Int       @default(0)
  status               String    @default("draft")
  created_at           DateTime  @default(now())
  updated_at           DateTime  @default(now())

  // Relations
  journey              developer_journeys              @relation(fields: [developer_journey_id], references: [id], onDelete: Cascade)
  trackings            developer_journey_trackings[]
  exam_registrations   exam_registrations[]

  @@map("developer_journey_tutorials")
}

// ============================================
// 6. DEVELOPER JOURNEY TRACKINGS
// ============================================
model developer_journey_trackings {
  id              String    @id @default(uuid())
  journey_id      String
  tutorial_id     String
  developer_id    String
  status          Int       @default(0)
  last_viewed     DateTime? @default(now())
  first_opened_at DateTime? @default(now())
  completed_at    DateTime?
  created_at      DateTime  @default(now())

  // Relations
  journey         developer_journeys              @relation(fields: [journey_id], references: [id])
  tutorial        developer_journey_tutorials     @relation(fields: [tutorial_id], references: [id])
  user            users                           @relation(fields: [developer_id], references: [id])

  @@map("developer_journey_trackings")
}

// ============================================
// 7. DEVELOPER JOURNEY SUBMISSIONS
// ============================================
model developer_journey_submissions {
  id           String    @id @default(uuid())
  journey_id   String
  submitter_id String
  status       String    @default("submitted")
  rating       Int?
  created_at   DateTime  @default(now())
  updated_at   DateTime  @default(now())

  // Relations
  journey      developer_journeys              @relation(fields: [journey_id], references: [id])
  submitter    users                           @relation(fields: [submitter_id], references: [id])

  @@map("developer_journey_submissions")
}

// ============================================
// 8. DEVELOPER JOURNEY COMPLETIONS
// ============================================
model developer_journey_completions {
  id         String    @id @default(uuid())
  user_id    String
  journey_id String
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())

  // Relations
  user       users                           @relation(fields: [user_id], references: [id])
  journey    developer_journeys              @relation(fields: [journey_id], references: [id])

  @@map("developer_journey_completions")
}

// ============================================
// 9. EXAM REGISTRATIONS
// ============================================
model exam_registrations {
  id               String    @id @default(uuid())
  tutorial_id      String?
  examinees_id     String
  status           String    @default("registered")
  created_at       DateTime  @default(now())
  updated_at       DateTime  @default(now())
  exam_finished_at DateTime?

  // Relations
  tutorial         developer_journey_tutorials?    @relation(fields: [tutorial_id], references: [id])
  examinee         users                           @relation(fields: [examinees_id], references: [id])
  results          exam_results[]

  @@map("exam_registrations")
}

// ============================================
// 10. EXAM RESULTS
// ============================================
model exam_results {
  id                   String    @id @default(uuid())
  exam_registration_id String
  total_questions      Int       @default(20)
  score                Int
  is_passed            Boolean   @default(false)
  created_at           DateTime  @default(now())

  // Relations
  exam_registration    exam_registrations              @relation(fields: [exam_registration_id], references: [id])

  @@map("exam_results")
}

// ============================================
// 11. POMODORO SESSIONS (NEW TABLE)
// ============================================
model pomodoro_sessions {
  id               String   @id @default(uuid())
  user_id          String
  journey_id       String?
  duration_minutes Int      @default(25)
  completed_at     DateTime @default(now()) @db.Timestamptz(6)

  // Relations (Sekarang sudah valid karena ada back-relation di Users & Journeys)
  user    users               @relation(fields: [user_id], references: [id])
  journey developer_journeys? @relation(fields: [journey_id], references: [id])

  @@map("pomodoro_sessions")
}